#!/bin/bash
#
#############
# CHANGELOG #
#############
#
# 2016-04-03 <fewbits> Creation of this script
#
########
# TODO #
########
#
# [X] Create the output file based on the hostname and current timestamp
# [_] Create repository in a local text file
# [_] Split repository entries by module
# [_] Execute each module (if it has at least one entry)
# [_] Sort and exclude repeated entries from the output file
# [_] Remove temporary files
# [_] Create syntax message
# [_] Create help message
# [_] Create option to reuse or force a new repository
#
#########
# FIXME #
#########
#
# [_] ???
#
#############
# Functions #
#############

function splashScreen() {
	echo
	echo "=> Welcome to fewbits/ibm-inventory <="
	echo
}

function logInfo() {
	#1 module
	#2 message
	
	echo "[`date +"%Y-%m-%d %H:%M:%S"`] [$1] $2"
}

function logError() {
	#1 module
	#2 message
	#3 error code
	
	echo "[`date +"%Y-%m-%d %H:%M:%S"`] [$1] $2"
	exit $3
}

function repositoryCreate() { # Creates a repository file with the software sources
	logInfo repository "Creating the source repository..."

	## Creating empty files
	#inventoryFile="$serverHostname-`date +%Y%m%d%H%M%S`"
	repositoryFilename=repository.txt
	repositorySwapFilename=$repositoryFilename.inventorytmp
	touch $repositoryFilename
	touch $repositorySwapFilename
	
	## Force new repository
	> $repositoryFilename
	> $repositorySwapFilename
	
	## Header
	echo "# Repository - Generated by fewbits/ibm-inventory.sh - Timestamp `date +'%Y-%m-%d %H:%M:%S'`"	>> $repositoryFilename
	echo >> $repositoryFilename
	
	## Populating the repository
	find / \( -name "db2ls" -o -name "mqsiprofile" -o -name "InterchangeSystem.log" -o -name "idsversion" -o -name "imcl" -o -name "versioninfo.sh" -o -name "Version.xml"-o -name "de_lsrootiu.sh" -o -name "nco_id" -o -name "FinalInstallInfo.txt" -o -name "versionInfo.sh" -o -name "fmcver" \) > $repositorySwapFilename 2>/dev/null
	
	## Number of sources founded
	repositorySources=`cat $repositorySwapFilename | wc -l`
	# If 0, end script
	if [ $repositorySources -eq 0 ]; then
		logError repository "Repository can't be created. No sources founded on this server. Check filesystem permissions, or maybe there is no software installed." 1
	# If 1 or more, continue
	else
		logInfo repository "Repository created. Number of sources: $repositorySources."
	fi
	
	## Formatting the output
	
	# DB2
	echo "[DB2]" >> $repositoryFilename
	grep db2ls $repositorySwapFilename | sort >> $repositoryFilename
	echo >> $repositoryFilename
	
	# Broker
	echo "[Broker]" >> $repositoryFilename
	grep mqsiprofile $repositorySwapFilename | sort >> $repositoryFilename
	echo >> $repositoryFilename

	# ICS
	echo "[ICS]" >> $repositoryFilename
	grep InterchangeSystem.log $repositorySwapFilename | sort >> $repositoryFilename
	echo >> $repositoryFilename

	# IDS
	echo "[IDS]" >> $repositoryFilename
	grep idsversion $repositorySwapFilename | sort >> $repositoryFilename
	echo >> $repositoryFilename

	# IM
	echo "[IM]" >> $repositoryFilename
	grep imcl $repositorySwapFilename | sort >> $repositoryFilename
	echo >> $repositoryFilename

	# Impact
	echo "[Impact]" >> $repositoryFilename
	grep versioninfo.sh $repositorySwapFilename | sort >> $repositoryFilename
	echo >> $repositoryFilename

	# InfoSphere
	echo "[InfoSphere]" >> $repositoryFilename
	grep Version.xml $repositorySwapFilename | sort >> $repositoryFilename
	echo >> $repositoryFilename

	# lsroot
	echo "[lsroot]" >> $repositoryFilename
	grep de_lsrootiu.sh $repositorySwapFilename | sort >> $repositoryFilename
	echo >> $repositoryFilename

	# OMNIbus
	echo "[OMNIbus]" >> $repositoryFilename
	grep nco_id $repositorySwapFilename | sort >> $repositoryFilename
	echo >> $repositoryFilename

	# Reporter
	echo "[Reporter]" >> $repositoryFilename
	grep FinalInstallInfo.txt $repositorySwapFilename | sort >> $repositoryFilename
	echo >> $repositoryFilename

	# WebSphere
	echo "[WebSphere]" >> $repositoryFilename
	grep versionInfo.sh $repositorySwapFilename | sort >> $repositoryFilename
	echo >> $repositoryFilename

	# Workflow
	echo "[Workflow]" >> $repositoryFilename
	grep fmcver $repositorySwapFilename | sort >> $repositoryFilename
	echo >> $repositoryFilename

}

function inventoryCreate() { # Creates the output/inventory file
	serverHostname=`hostname`
	#inventoryFile="$serverHostname-`date +%Y%m%d%H%M%S`"
	inventoryFilename="$serverHostname"
	touch $inventoryFilename
}

##########
# SCRIPT #
##########

splashScreen
repositoryCreate
inventoryCreate







